<?xml version="1.0" encoding="utf-8"?>
<queries>
    <query name="GetCupomByCodigo">
        SELECT
            id as Id,
            codigo as Codigo,
            tipo_desconto as TipoDesconto,
            valor as Valor,
            data_expiracao as DataExpiracao,
            limite_uso as LimiteUso,
            uso_atual as UsoAtual,
            ativo as Ativo,
            data_criacao as DataCriacao
        FROM cupom
        WHERE codigo = @Codigo AND ativo = true;
    </query>

    <query name="IncrementarUsoCupom">
        UPDATE cupom
        SET uso_atual = uso_atual + 1
        WHERE id = @Id;
    </query>

    <query name="GetAllCupons">
        SELECT * FROM cupom ORDER BY data_criacao DESC;
    </query>

    <query name="CreateCupom">
        INSERT INTO cupom (codigo, tipo_desconto, valor, data_expiracao, limite_uso)
        VALUES (@Codigo, @TipoDesconto, @Valor, @DataExpiracao, @LimiteUso)
        RETURNING id;
    </query>

    <query name="DeleteCupom">
        DELETE FROM cupom WHERE id = @Id;
    </query>

    <query name="SearchOrders">
        <![CDATA[
            SELECT
                id as Id,
                usuario_id as UserId,
                data_pedido as OrderDate,
                status_pedido as Status,
                mercadopago_pagamento_id as PaymentId,
                preference_id as PreferenceId,
                metodo_pagamento as PaymentMethod,
                total_pedido as TotalAmount,
                cupom_id as CupomId
            FROM
                pedido
            WHERE
                usuario_id = @UserId
                AND (@Status IS NULL OR status_pedido = @Status)
                AND (@StartDate IS NULL OR data_pedido >= @StartDate)
                AND (@EndDate IS NULL OR data_pedido <= @EndDate)
                AND (@SearchQuery IS NULL OR id::text ILIKE @SearchQuery)
            ORDER BY
                data_pedido DESC
            OFFSET (@Page - 1) * @Limit
            LIMIT @Limit;
        ]]>
    </query>
</queries>
