<?xml version="1.0" encoding="utf-8"?>
<queries>
    <!-- Consulta para obter todos os produtos -->
    <query name="GetAllProducts">
        SELECT
            p.id AS Id,
            p.nome AS Nome,
            p.descricao AS Descricao,
            p.preco AS Preco,
            p.preco_original AS PrecoOriginal,
            COALESCE(pc.nome, '') AS CategoriaNome,
            COALESCE(ps.nome, '') AS SubcategoriaNome,
            p.subcategoria_id AS Subcategoria,
            p.ativo AS Ativo,
            p.data_criacao AS DataCriacao,
            p.data_atualizacao AS DataAtualizacao,
            p.descricao_detalhada AS DescricaoDetalhada,
            p.destaque AS Destaque,
            (SELECT COALESCE(AVG(nota), 0) FROM avaliacao WHERE produto_id = p.id AND ativo = true) as AvaliacaoMedia,
            (SELECT COUNT(*) FROM avaliacao WHERE produto_id = p.id AND ativo = true) as NumeroAvaliacoes
        FROM produto p
        LEFT JOIN produto_subcategoria ps ON p.subcategoria_id = ps.id
        LEFT JOIN produto_categoria pc ON ps.categoria_id = pc.id
        WHERE p.ativo = true
        ORDER BY p.data_criacao DESC;
    </query>

    <!-- Consulta para obter um produto por ID -->
    <query name="GetProductById">
        SELECT
            p.id AS Id,
            p.nome AS Nome,
            p.descricao AS Descricao,
            p.preco AS Preco,
            p.preco_original AS PrecoOriginal,
            COALESCE(pc.nome, '') AS CategoriaNome,
            COALESCE(ps.nome, '') AS SubcategoriaNome,
            p.subcategoria_id AS Subcategoria,
            p.ativo AS Ativo,
            p.data_criacao AS DataCriacao,
            p.data_atualizacao AS DataAtualizacao,
            p.descricao_detalhada AS DescricaoDetalhada,
            p.destaque AS Destaque,
            (SELECT COALESCE(AVG(nota), 0) FROM avaliacao WHERE produto_id = p.id AND ativo = true) as AvaliacaoMedia,
            (SELECT COUNT(*) FROM avaliacao WHERE produto_id = p.id AND ativo = true) as NumeroAvaliacoes
        FROM produto p
        LEFT JOIN produto_subcategoria ps ON p.subcategoria_id = ps.id
        LEFT JOIN produto_categoria pc ON ps.categoria_id = pc.id
        WHERE p.id = @Id AND p.ativo = true;
    </query>

    <!-- Query para buscar produtos com filtros -->
    <query name="SearchProducts">
        <![CDATA[
            SELECT
                p.id AS "Id",
                p.nome AS "Nome",
                p.descricao AS "Descricao",
                p.preco AS "Preco",
                p.preco_original AS "PrecoOriginal",
                COALESCE(pc.nome, '') AS "CategoriaNome",
                COALESCE(ps.nome, '') AS "SubcategoriaNome",
                p.subcategoria_id AS "Subcategoria",
                p.ativo AS "Ativo",
                p.data_criacao AS "DataCriacao",
                p.data_atualizacao AS "DataAtualizacao",
                p.descricao_detalhada AS "DescricaoDetalhada",
                p.destaque AS "Destaque",
                (SELECT COALESCE(AVG(nota), 0) FROM avaliacao WHERE produto_id = p.id AND ativo = true) as AvaliacaoMedia,
                (SELECT COUNT(*) FROM avaliacao WHERE produto_id = p.id AND ativo = true) as NumeroAvaliacoes
            FROM
                produto AS p
            LEFT JOIN
                produto_subcategoria AS ps ON p.subcategoria_id = ps.id
            LEFT JOIN
                produto_categoria AS pc ON ps.categoria_id = pc.id
            WHERE
                p.ativo = TRUE
                AND (@SearchPattern IS NULL OR p.nome ILIKE @SearchPattern OR p.descricao ILIKE @SearchPattern)
                AND (@CategoriaID IS NULL OR ps.categoria_id = @CategoriaID)
                AND (@SubcategoriaID IS NULL OR p.subcategoria_id = @SubcategoriaID)
                AND (@MinPrice IS NULL OR p.preco >= @MinPrice)
                AND (@MaxPrice IS NULL OR p.preco <= @MaxPrice)
            ORDER BY
                CASE WHEN @SortBy = 'price-low' THEN p.preco END ASC,
                CASE WHEN @SortBy = 'price-high' THEN p.preco END DESC,
                CASE WHEN @SortBy = 'name' THEN p.nome END ASC,
                CASE WHEN @SortBy = 'newest' OR @SortBy IS NULL THEN p.data_criacao END DESC,
                p.id ASC
            OFFSET (@Page - 1) * @Limit
            LIMIT @Limit;
        ]]>
    </query>

    <!-- Mantive as outras queries de Insert/Update/Delete/Variations inalteradas para brevidade -->
    <query name="AddProduct">
        INSERT INTO produto (id, nome, descricao, preco, preco_original, subcategoria_id, ativo, descricao_detalhada, destaque)
        VALUES (@Id, @Nome, @Descricao, @Preco, @PrecoOriginal, @SubcategoriaId, @Ativo, @DescricaoDetalhada, @Destaque)
        RETURNING id;
    </query>

    <query name="AddProductVariation">
        INSERT INTO produto_variacao (id, produto_id, cor_id, tamanho_id, estoque, sku, ordem, data_criacao)
        VALUES (@Id, @ProdutoId, @CorId, @TamanhoId, @Estoque, @Sku, @Ordem, @DataCriacao)
        RETURNING id;
    </query>

    <query name="GetCategoryIdByName">
        SELECT id FROM produto_categoria WHERE nome = @Nome;
    </query>

    <query name="GetSubcategoryIdByName">
        SELECT id FROM produto_subcategoria WHERE nome = @Nome;
    </query>

    <query name="AddProductImages">
        INSERT INTO produto_imagem (id, produto_variacao_id, imagem_url, imagem_alt, ordem)
        VALUES (@Id, @ProdutoVariacaoId, @ImagemUrl, @ImagemAlt, @Ordem);
    </query>

    <query name="UpdateProductImage">
        UPDATE produto_imagem
        SET
            ordem = @Ordem,
            imagem_url = @ImagemUrl,
            imagem_alt = @ImagemAlt
        WHERE id = @Id;
    </query>

    <query name="DeleteProductById">
        DELETE FROM produto WHERE id = @Id;
    </query>

    <query name="AddProductCategory">
        INSERT INTO produto_categoria(nome)
        VALUES (@Nome)
        RETURNING id;
    </query>

    <query name="AddProductSubCategory">
        INSERT INTO produto_subcategoria(nome, categoria_id)
        VALUES (@Nome, @CategoriaId)
        RETURNING id;
    </query>

    <query name="AddProductColor">
        INSERT INTO produto_cor(nome)
        VALUES (@Nome)
        RETURNING id;
    </query>

    <query name="GetColorIdByName">
        SELECT id FROM produto_cor WHERE nome = @Nome;
    </query>

    <query name="AddProductSize">
        INSERT INTO produto_tamanho(nome, descricao)
        VALUES (@Nome, @Descricao)
        RETURNING id;
    </query>

    <query name="GetSizeIdByName">
        SELECT id FROM produto_tamanho WHERE nome = @Nome;
    </query>

    <query name="GetVariationsByProductId">
        SELECT 
            v.id AS Id,
            v.produto_id AS ProdutoId,
            v.cor_id AS CorId,
            c.nome AS Cor,
            v.tamanho_id AS TamanhoId,
            t.nome AS Tamanho,
            v.estoque AS Estoque,
            COALESCE(r.quantidade_reservada, 0) as EstoqueReservado,
            (v.estoque - COALESCE(r.quantidade_reservada, 0)) as EstoqueDisponivel,
            v.sku AS Sku,
            v.ordem AS Ordem,
            v.data_criacao AS DataCriacao,
            v.data_atualizacao AS DataAtualizacao,
            pi.id AS Id,
            pi.produto_variacao_id AS ProdutoVariacaoId,
            pi.imagem_url AS ImagemUrl,
            pi.imagem_alt AS ImagemAlt,
            pi.ordem AS Ordem
        FROM produto_variacao v
        INNER JOIN produto_cor c ON v.cor_id = c.id
        INNER JOIN produto_tamanho t ON v.tamanho_id = t.id
        LEFT JOIN (
            SELECT produto_variacao_id, SUM(quantidade) as quantidade_reservada
            FROM reserva_produto 
            WHERE ativo = true AND data_expira > NOW()
            GROUP BY produto_variacao_id
        ) r ON r.produto_variacao_id = v.id
        LEFT JOIN produto_imagem pi ON pi.produto_variacao_id = v.id
        WHERE v.produto_id = @ProductId
        ORDER BY v.ordem, pi.ordem;
    </query>

    <query name="GetVariationById">
        SELECT 
            v.id AS Id,
            v.produto_id AS ProdutoId,
            v.cor_id AS CorId,
            c.nome AS Cor,
            v.tamanho_id AS TamanhoId,
            t.nome AS Tamanho,
            v.estoque AS Estoque,
            COALESCE(r.quantidade_reservada, 0) as EstoqueReservado,
            (v.estoque - COALESCE(r.quantidade_reservada, 0)) as EstoqueDisponivel,
            v.sku AS Sku,
            v.ordem AS Ordem,
            v.data_criacao AS DataCriacao,
            v.data_atualizacao AS DataAtualizacao
        FROM produto_variacao v
        INNER JOIN produto_cor c ON v.cor_id = c.id
        INNER JOIN produto_tamanho t ON v.tamanho_id = t.id
        LEFT JOIN (
            SELECT produto_variacao_id, SUM(quantidade) as quantidade_reservada
            FROM reserva_produto 
            WHERE ativo = true AND data_expira > NOW()
            GROUP BY produto_variacao_id
        ) r ON r.produto_variacao_id = v.id
        WHERE v.id = @Id;
    </query>

    <query name="CheckVariationExists">
        SELECT COUNT(*) FROM produto_variacao v
        INNER JOIN produto_cor c ON v.cor_id = c.id
        INNER JOIN produto_tamanho t ON v.tamanho_id = t.id
        WHERE v.produto_id = @ProductId AND LOWER(c.nome) = LOWER(@Cor) AND LOWER(t.nome) = LOWER(@Tamanho);
    </query>

    <query name="UpdateVariation">
        UPDATE produto_variacao 
        SET cor_id = @CorId, 
            tamanho_id = @TamanhoId, 
            estoque = @Estoque, 
            ordem = @Ordem, 
            data_atualizacao = NOW()
        WHERE id = @Id;
    </query>

    <query name="UpdateProduct">
        UPDATE produto
        SET nome = @Nome,
            descricao = @Descricao,
            preco = @Preco,
            preco_original = @PrecoOriginal,
            data_atualizacao = @DataAtualizacao,
            descricao_detalhada = @DescricaoDetalhada,
            destaque = @Destaque
        WHERE id = @Id;
    </query>

    <query name="DeleteVariation">
        DELETE FROM produto_variacao WHERE id = @Id;
    </query>

    <query name="DeleteVariationImages">
        DELETE FROM produto_imagem WHERE produto_variacao_id = @VariationId;
    </query>

    <query name="GetVariationImages">
        SELECT 
            id AS Id,
            produto_variacao_id AS ProdutoVariacaoId,
            imagem_url AS ImagemUrl,
            imagem_alt AS ImagemAlt,
            ordem AS Ordem
        FROM produto_imagem 
        WHERE produto_variacao_id = @VariationId
        ORDER BY ordem;
    </query>

    <query name="RemoveProductStockAmount">
        UPDATE produto_variacao
        SET estoque = estoque - @Amount
        WHERE id = @Id
        AND estoque >= @Amount;
    </query>

    <query name="CheckProductStock">
        SELECT estoque
        FROM produto_variacao
        WHERE id = @Id
    </query>

    <query name="GetVariationsWithProductByIds">
        SELECT DISTINCT ON (pv.id)
        pv.id as VariationId,
        pv.produto_id as ProductId,
        p.nome as ProductName,
        p.preco as Preco,
        pc.nome as ColorName,
        pt.nome as SizeName,
        pv.estoque as Stock,
        COALESCE(r.quantidade_reservada, 0) as ReservedStock,
        (pv.estoque - COALESCE(r.quantidade_reservada, 0)) as AvailableStock,
        pi.imagem_url as ImageUrl,
        pi.imagem_alt as ImageAlt
        FROM produto_variacao pv
        INNER JOIN produto p ON pv.produto_id = p.id
        LEFT JOIN produto_cor pc ON pv.cor_id = pc.id
        LEFT JOIN produto_tamanho pt ON pv.tamanho_id = pt.id
        LEFT JOIN produto_imagem pi ON pi.produto_variacao_id = v.id
        LEFT JOIN (
            SELECT produto_variacao_id, SUM(quantidade) as quantidade_reservada
            FROM reserva_produto 
            WHERE ativo = true AND data_expira > NOW()
            GROUP BY produto_variacao_id
        ) r ON r.produto_variacao_id = pv.id
        WHERE pv.id = ANY(@VariationIds) AND p.ativo = true
        ORDER BY pv.id, pi.ordem ASC NULLS LAST;
    </query>

    <query name="GetImageById">
        SELECT 
            id AS Id,
            produto_variacao_id AS ProdutoVariacaoId,
            imagem_url AS ImagemUrl,
            imagem_alt AS ImagemAlt,
            ordem AS Ordem
        FROM produto_imagem 
        WHERE id = @Id;
    </query>

    <query name="DeleteImageById">
        DELETE FROM produto_imagem WHERE id = @Id;
    </query>
    
    <query name="GetProductByProductVariationId">
        SELECT
            p.id AS Id,
            p.nome AS Nome,
            p.descricao AS Descricao,
            p.preco AS Preco,
            p.preco_original AS PrecoOriginal,
            COALESCE(pc.nome, '') AS CategoriaNome,
            COALESCE(ps.nome, '') AS SubcategoriaNome,
            p.subcategoria_id AS Subcategoria,
            p.ativo AS Ativo,
            p.data_criacao AS DataCriacao,
            p.data_atualizacao AS DataAtualizacao,
            p.descricao_detalhada AS DescricaoDetalhada,
            p.destaque AS Destaque
        FROM produto p
        INNER JOIN produto_variacao pv ON pv.produto_id = p.id
        LEFT JOIN produto_subcategoria ps ON p.subcategoria_id = ps.id
        LEFT JOIN produto_categoria pc ON ps.categoria_id = pc.id
        WHERE pv.id = @ProductVariationId;
    </query>

    <query name="CheckMultipleProductsStock">
        SELECT * FROM check_multiple_products_stock(@VariationIds, @Quantities);
    </query>

    <query name="RemoveMultipleProductsStockDirect">
        SELECT * FROM remove_multiple_products_stock_direct(@VariationIds, @Quantities);
    </query>

    <query name="AddProductSpecification">
        INSERT INTO produto_especificacao (id, produto_id, nome, valor)
        VALUES (@Id, @ProdutoId, @Nome, @Valor);
    </query>

    <query name="DeleteProductSpecifications">
        DELETE FROM produto_especificacao WHERE produto_id = @ProdutoId;
    </query>

    <query name="GetProductSpecifications">
        SELECT id AS Id, produto_id AS ProdutoId, nome AS Nome, valor AS Valor
        FROM produto_especificacao
        WHERE produto_id = @ProdutoId;
    </query>

    <query name="AddProductShippingInfo">
        INSERT INTO produto_informacao_envio (id, produto_id, frete_gratis, dias_estimados, custo_envio, politica_devolucao, garantia)
        VALUES (@Id, @ProdutoId, @FreteGratis, @DiasEstimados, @CustoEnvio, @PoliticaDevolucao, @Garantia);
    </query>

    <query name="UpdateProductShippingInfo">
        INSERT INTO produto_informacao_envio (id, produto_id, frete_gratis, dias_estimados, custo_envio, politica_devolucao, garantia)
        VALUES (@Id, @ProdutoId, @FreteGratis, @DiasEstimados, @CustoEnvio, @PoliticaDevolucao, @Garantia)
        ON CONFLICT (produto_id) DO UPDATE SET
            frete_gratis = EXCLUDED.frete_gratis,
            dias_estimados = EXCLUDED.dias_estimados,
            custo_envio = EXCLUDED.custo_envio,
            politica_devolucao = EXCLUDED.politica_devolucao,
            garantia = EXCLUDED.garantia;
    </query>

    <query name="GetProductShippingInfo">
        SELECT id AS Id, produto_id AS ProdutoId, frete_gratis AS FreteGratis, dias_estimados AS DiasEstimados, custo_envio AS CustoEnvio, politica_devolucao AS PoliticaDevolucao, garantia AS Garantia
        FROM produto_informacao_envio
        WHERE produto_id = @ProdutoId;
    </query>

    <query name="DeleteProductShippingInfo">
        DELETE FROM produto_informacao_envio WHERE produto_id = @ProdutoId;
    </query>

    <query name="AddProductPerfectFor">
        INSERT INTO produto_perfeito_para (id, produto_id, ocasiao)
        VALUES (@Id, @ProdutoId, @Ocasiao);
    </query>

    <query name="DeleteProductPerfectFor">
        DELETE FROM produto_perfeito_para WHERE produto_id = @ProdutoId;
    </query>

    <query name="GetProductPerfectFor">
        SELECT ocasiao FROM produto_perfeito_para WHERE produto_id = @ProdutoId;
    </query>

    <query name="GetProductReviews">
        SELECT
            a.id AS Id,
            a.usuario_id AS UsuarioId,
            u.nome AS UsuarioNome,
            u.imagem_url AS UsuarioAvatar,
            a.produto_id AS ProdutoId,
            a.nota AS Nota,
            a.comentario AS Comentario,
            a.data_avaliacao AS DataAvaliacao
        FROM avaliacao a
        INNER JOIN usuario u ON a.usuario_id = u.id
        WHERE a.produto_id = @ProductId AND a.ativo = true
        ORDER BY a.data_avaliacao DESC;
    </query>
</queries>
