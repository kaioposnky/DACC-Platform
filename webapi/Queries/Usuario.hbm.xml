<?xml version="1.0" encoding="utf-8"?>
<queries>
	<query name="InsertUsuario">
		INSERT INTO usuario (nome, sobrenome, ra, curso, email, telefone, senha_hash, cargo, imagem_url)
		VALUES (@Nome, @Sobrenome, @Ra, @Curso, @Email, @Telefone, @Senha, @Cargo, @ImagemUrl)
		RETURNING id;
	</query>
	
	<query name="GetAllUsers">
		SELECT
			id as Id,
			nome as Nome,
			sobrenome as Sobrenome,
			ra as Ra,
			curso as Curso,
			email as Email,
			telefone as Telefone,
			imagem_url as ImagemUrl,
			ativo as Ativo,
			newsletter_subscriber as NewsLetterSubscriber,
			cargo as Cargo,
			data_criacao as DataCriacao,
			data_atualizacao as DataAtualizacao
		FROM usuario;
	</query>

	<query name="GetUserById">
		SELECT
		id as Id,
		nome as Nome,
		sobrenome as Sobrenome,
		ra as Ra,
		curso as Curso,
		email as Email,
		telefone as Telefone,
		imagem_url as ImagemUrl,
		ativo as Ativo,
		newsletter_subscriber as NewsLetterSubscriber,
		cargo as Cargo,
		data_criacao as DataCriacao,
		data_atualizacao as DataAtualizacao
		FROM usuario
		WHERE id = @Id;
	</query>

	<query name="GetUserByRA">
		SELECT
		id as Id,
		nome as Nome,
		sobrenome as Sobrenome,
		ra as Ra,
		curso as Curso,
		email as Email,
		telefone as Telefone,
		imagem_url as ImagemUrl,
		ativo as Ativo,
		newsletter_subscriber as NewsLetterSubscriber,
		cargo as Cargo,
		data_criacao as DataCriacao,
		data_atualizacao as DataAtualizacao
		FROM usuario
		WHERE ra = @Ra;
	</query>
	
	<query name="GetUserByEmail">
		SELECT
		id as Id,
		nome as Nome,
		sobrenome as Sobrenome,
		ra as Ra,
		curso as Curso,
		email as Email,
		telefone as Telefone,
		senha_hash as SenhaHash,
		imagem_url as ImagemUrl,
		ativo as Ativo,
		newsletter_subscriber as NewsLetterSubscriber,
		cargo as Cargo,
		data_criacao as DataCriacao,
		data_atualizacao as DataAtualizacao
		FROM usuario
		WHERE email = @Email;
	</query>

	<query name="UpdateUser">
		UPDATE usuario
		SET 
			nome = @Nome, 
			sobrenome = @Sobrenome,
			curso = @Curso,
			telefone = @Telefone,
			imagem_url = @ImagemUrl,
			newsletter_subscriber = @NewsLetterSubscriber,
			data_atualizacao = CURRENT_TIMESTAMP
		WHERE id = @Id;
	</query>

	<query name="UpdateUserPassword">
		UPDATE usuario
		SET
			senha_hash = @SenhaHash,
			data_atualizacao = CURRENT_TIMESTAMP
		WHERE id = @Id;
	</query>

	<query name="DeleteUser">
		DELETE FROM usuario
		WHERE id = @Id;
	</query>

	<query name="GetUserTokens">
		SELECT
		access_token as AccessToken,
		refresh_token as RefreshToken
		FROM usuario_tokens
		WHERE usuario_id = @Id;
	</query>

	<query name="UpdateUserTokens">
		UPDATE usuario_tokens
		SET
		access_token = @AccessToken,
		refresh_token = @RefreshToken
		WHERE usuario_id = @Id;
	</query>

	<query name="CreateUserToken">
		INSERT INTO usuario_tokens(usuario_id, access_token, refresh_token)
		VALUES (@UserId, '', '');
	</query>

	<query name="GetUserStats">
		SELECT
			(SELECT COUNT(*) FROM pedido WHERE usuario_id = @Id) as Orders,
			(SELECT COUNT(*) FROM avaliacao WHERE usuario_id = @Id) as Reviews,
			TO_CHAR(data_criacao, 'DD/MM/YYYY') as RegistryDate
		FROM usuario
		WHERE id = @Id;
	</query>

	<query name="SaveResetToken">
		INSERT INTO usuario_reset_tokens (usuario_id, token, data_expiracao)
		VALUES (@UsuarioId, @Token, @DataExpiracao);
	</query>

	<query name="GetResetToken">
		SELECT
			id as Id,
			usuario_id as UsuarioId,
			token as Token,
			data_expiracao as DataExpiracao,
			usado as Usado,
			data_usada as DataUsada,
			data_criacao as DataCriacao
		FROM usuario_reset_tokens
		WHERE token = @Token;
	</query>

	<query name="InvalidateResetToken">
		UPDATE usuario_reset_tokens
		SET usado = true, data_usada = CURRENT_TIMESTAMP
		WHERE id = @Id;
	</query>
</queries>